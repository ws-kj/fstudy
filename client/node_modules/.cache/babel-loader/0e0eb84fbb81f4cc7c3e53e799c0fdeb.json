{"ast":null,"code":"'use strict';\n\nvar promisify = require('promisify-es6');\n\nvar dagPB = require('ipld-dag-pb');\n\nvar DAGNode = dagPB.DAGNode;\n\nvar LRU = require('lru-cache');\n\nvar lruOptions = {\n  max: 128\n};\nvar cache = LRU(lruOptions);\n\nvar SendOneFile = require('../utils/send-one-file');\n\nvar once = require('once');\n\nmodule.exports = function (send) {\n  var sendOneFile = SendOneFile(send, 'object/put');\n  return promisify(function (obj, options, _callback) {\n    if (typeof options === 'function') {\n      _callback = options;\n      options = {};\n    }\n\n    var callback = once(_callback);\n\n    if (!options) {\n      options = {};\n    }\n\n    var tmpObj = {\n      Data: null,\n      Links: []\n    };\n\n    if (Buffer.isBuffer(obj)) {\n      if (!options.enc) {\n        tmpObj = {\n          Data: obj.toString(),\n          Links: []\n        };\n      }\n    } else if (obj.multihash) {\n      tmpObj = {\n        Data: obj.data.toString(),\n        Links: obj.links.map(function (l) {\n          var link = l.toJSON();\n          link.hash = link.multihash;\n          return link;\n        })\n      };\n    } else if (typeof obj === 'object') {\n      tmpObj.Data = obj.Data.toString();\n      tmpObj.Links = obj.Links;\n    } else {\n      return callback(new Error('obj not recognized'));\n    }\n\n    var buf;\n\n    if (Buffer.isBuffer(obj) && options.enc) {\n      buf = obj;\n    } else {\n      buf = Buffer.from(JSON.stringify(tmpObj));\n    }\n\n    var enc = options.enc || 'json';\n    var sendOptions = {\n      qs: {\n        inputenc: enc\n      }\n    };\n    sendOneFile(buf, sendOptions, function (err, result) {\n      if (err) {\n        return callback(err); // early\n      }\n\n      if (Buffer.isBuffer(obj)) {\n        if (!options.enc) {\n          obj = {\n            Data: obj,\n            Links: []\n          };\n        } else if (options.enc === 'json') {\n          obj = JSON.parse(obj.toString());\n        }\n      }\n\n      var node;\n\n      if (obj.multihash) {\n        node = obj;\n      } else if (options.enc === 'protobuf') {\n        dagPB.util.deserialize(obj, function (err, _node) {\n          if (err) {\n            return callback(err);\n          }\n\n          node = _node;\n          next();\n        });\n        return;\n      } else {\n        DAGNode.create(Buffer.from(obj.Data), obj.Links, function (err, _node) {\n          if (err) {\n            return callback(err);\n          }\n\n          node = _node;\n          next();\n        });\n        return;\n      }\n\n      next();\n\n      function next() {\n        var nodeJSON = node.toJSON();\n\n        if (nodeJSON.multihash !== result.Hash) {\n          var _err = new Error('multihashes do not match');\n\n          return callback(_err);\n        }\n\n        cache.set(result.Hash, node);\n        callback(null, node);\n      }\n    });\n  });\n};","map":{"version":3,"sources":["/home/will/src/fstudy/client/node_modules/ipfs-api/src/object/put.js"],"names":["promisify","require","dagPB","DAGNode","LRU","lruOptions","max","cache","SendOneFile","once","module","exports","send","sendOneFile","obj","options","_callback","callback","tmpObj","Data","Links","Buffer","isBuffer","enc","toString","multihash","data","links","map","l","link","toJSON","hash","Error","buf","from","JSON","stringify","sendOptions","qs","inputenc","err","result","parse","node","util","deserialize","_node","next","create","nodeJSON","Hash","set"],"mappings":"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","sourcesContent":["'use strict'\n\nconst promisify = require('promisify-es6')\nconst dagPB = require('ipld-dag-pb')\nconst DAGNode = dagPB.DAGNode\nconst LRU = require('lru-cache')\nconst lruOptions = {\n  max: 128\n}\n\nconst cache = LRU(lruOptions)\nconst SendOneFile = require('../utils/send-one-file')\nconst once = require('once')\n\nmodule.exports = (send) => {\n  const sendOneFile = SendOneFile(send, 'object/put')\n\n  return promisify((obj, options, _callback) => {\n    if (typeof options === 'function') {\n      _callback = options\n      options = {}\n    }\n\n    const callback = once(_callback)\n\n    if (!options) {\n      options = {}\n    }\n\n    let tmpObj = {\n      Data: null,\n      Links: []\n    }\n\n    if (Buffer.isBuffer(obj)) {\n      if (!options.enc) {\n        tmpObj = {\n          Data: obj.toString(),\n          Links: []\n        }\n      }\n    } else if (obj.multihash) {\n      tmpObj = {\n        Data: obj.data.toString(),\n        Links: obj.links.map((l) => {\n          const link = l.toJSON()\n          link.hash = link.multihash\n          return link\n        })\n      }\n    } else if (typeof obj === 'object') {\n      tmpObj.Data = obj.Data.toString()\n      tmpObj.Links = obj.Links\n    } else {\n      return callback(new Error('obj not recognized'))\n    }\n\n    let buf\n    if (Buffer.isBuffer(obj) && options.enc) {\n      buf = obj\n    } else {\n      buf = Buffer.from(JSON.stringify(tmpObj))\n    }\n    const enc = options.enc || 'json'\n\n    const sendOptions = {\n      qs: { inputenc: enc }\n    }\n\n    sendOneFile(buf, sendOptions, (err, result) => {\n      if (err) {\n        return callback(err) // early\n      }\n\n      if (Buffer.isBuffer(obj)) {\n        if (!options.enc) {\n          obj = { Data: obj, Links: [] }\n        } else if (options.enc === 'json') {\n          obj = JSON.parse(obj.toString())\n        }\n      }\n\n      let node\n\n      if (obj.multihash) {\n        node = obj\n      } else if (options.enc === 'protobuf') {\n        dagPB.util.deserialize(obj, (err, _node) => {\n          if (err) {\n            return callback(err)\n          }\n          node = _node\n          next()\n        })\n        return\n      } else {\n        DAGNode.create(Buffer.from(obj.Data), obj.Links, (err, _node) => {\n          if (err) {\n            return callback(err)\n          }\n          node = _node\n          next()\n        })\n        return\n      }\n      next()\n\n      function next () {\n        const nodeJSON = node.toJSON()\n        if (nodeJSON.multihash !== result.Hash) {\n          const err = new Error('multihashes do not match')\n          return callback(err)\n        }\n\n        cache.set(result.Hash, node)\n        callback(null, node)\n      }\n    })\n  })\n}\n"]},"metadata":{},"sourceType":"script"}